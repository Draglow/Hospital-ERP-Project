{% extends 'dashboard/mobile/base.html' %}
{% load static %}

{% block title %}Mobile Settings Test - Ethiopian Hospital ERP{% endblock %}

{% block content %}
<!-- Mobile Settings Test Page -->
<div class="mobile-page-header">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h1 class="h4 mb-1">Mobile Settings Test</h1>
            <p class="text-muted mb-0">Test all mobile settings functionality</p>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-sm btn-primary" onclick="runAllTests()">
                <i class="fas fa-play"></i> Run Tests
            </button>
            <a href="{% url 'accounts:settings' %}?mobile=1" class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-arrow-left"></i>
            </a>
        </div>
    </div>
</div>

<!-- Test Results Container -->
<div class="mobile-dashboard-card mb-4">
    <h6 class="text-ethiopia-green mb-3">
        <i class="fas fa-clipboard-check me-2"></i>Test Results
    </h6>
    <div id="testResults" class="test-results-container">
        <p class="text-muted">Click "Run Tests" to start testing mobile settings functionality</p>
    </div>
</div>

<!-- Touch Target Size Test -->
<div class="mobile-dashboard-card mb-3">
    <h6 class="text-ethiopia-blue mb-3">
        <i class="fas fa-hand-pointer me-2"></i>Touch Target Size Test
    </h6>
    <div class="mobile-settings-list">
        <div class="mobile-setting-item" id="touchTest1">
            <div class="mobile-setting-info">
                <div class="mobile-setting-title">Test Switch (44px minimum)</div>
                <small class="text-muted">This switch should be at least 44px in both dimensions</small>
            </div>
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="testSwitch1">
            </div>
        </div>
        
        <div class="mobile-setting-item" id="touchTest2">
            <div class="mobile-setting-info">
                <div class="mobile-setting-title">Test Button (44px minimum)</div>
                <small class="text-muted">This button should be at least 44px in both dimensions</small>
            </div>
            <button class="btn btn-sm btn-outline-primary" id="testButton1">
                <i class="fas fa-test"></i>
            </button>
        </div>
        
        <div class="mobile-setting-item" id="touchTest3">
            <div class="mobile-setting-info">
                <div class="mobile-setting-title">Test Select (44px minimum height)</div>
                <small class="text-muted">This select should be at least 44px high</small>
            </div>
            <select class="form-select form-select-sm" id="testSelect1" style="width: auto;">
                <option value="test1">Test Option 1</option>
                <option value="test2">Test Option 2</option>
            </select>
        </div>
    </div>
</div>

<!-- Animation Test -->
<div class="mobile-dashboard-card mb-3">
    <h6 class="text-ethiopia-yellow mb-3">
        <i class="fas fa-magic me-2"></i>Animation Test
    </h6>
    <div class="d-flex gap-2 flex-wrap">
        <button class="btn btn-sm btn-outline-primary" onclick="testRippleEffect()">
            Test Ripple Effect
        </button>
        <button class="btn btn-sm btn-outline-success" onclick="testSuccessAnimation()">
            Test Success Animation
        </button>
        <button class="btn btn-sm btn-outline-danger" onclick="testErrorAnimation()">
            Test Error Animation
        </button>
        <button class="btn btn-sm btn-outline-info" onclick="testLoadingAnimation()">
            Test Loading Animation
        </button>
    </div>
</div>

<!-- Form Validation Test -->
<div class="mobile-dashboard-card mb-3">
    <h6 class="text-ethiopia-red mb-3">
        <i class="fas fa-exclamation-triangle me-2"></i>Form Validation Test
    </h6>
    <div class="mobile-settings-list">
        <div class="mobile-setting-item">
            <div class="mobile-setting-info">
                <div class="mobile-setting-title">Test Invalid Session Timeout</div>
                <small class="text-muted">Try setting an invalid value</small>
            </div>
            <select class="form-select form-select-sm" id="testSessionTimeout" style="width: auto;">
                <option value="30">30 minutes</option>
                <option value="60">1 hour</option>
                <option value="999">Invalid Value</option>
            </select>
        </div>
    </div>
    <button class="btn btn-sm btn-primary mt-2" onclick="testFormValidation()">
        Test Validation
    </button>
</div>

<!-- Network Test -->
<div class="mobile-dashboard-card mb-3">
    <h6 class="text-ethiopia-green mb-3">
        <i class="fas fa-network-wired me-2"></i>Network Test
    </h6>
    <div class="d-flex gap-2 flex-wrap">
        <button class="btn btn-sm btn-outline-primary" onclick="testSaveSettings()">
            Test Save Settings
        </button>
        <button class="btn btn-sm btn-outline-secondary" onclick="testGetSettings()">
            Test Get Settings
        </button>
        <button class="btn btn-sm btn-outline-warning" onclick="testResetSettings()">
            Test Reset Settings
        </button>
        <button class="btn btn-sm btn-outline-info" onclick="testNetworkError()">
            Test Network Error
        </button>
    </div>
</div>

<!-- Performance Test -->
<div class="mobile-dashboard-card mb-3">
    <h6 class="text-ethiopia-blue mb-3">
        <i class="fas fa-tachometer-alt me-2"></i>Performance Test
    </h6>
    <div id="performanceResults" class="mb-2">
        <p class="text-muted">Performance metrics will appear here</p>
    </div>
    <button class="btn btn-sm btn-primary" onclick="testPerformance()">
        Run Performance Test
    </button>
</div>
{% endblock %}

{% block extra_css %}
<style>
.test-results-container {
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 1rem;
    background: #f8f9fa;
}

.test-result {
    padding: 0.5rem;
    margin-bottom: 0.5rem;
    border-radius: 4px;
    font-family: monospace;
    font-size: 0.9rem;
}

.test-pass {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.test-fail {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.test-info {
    background: #d1ecf1;
    color: #0c5460;
    border: 1px solid #bee5eb;
}

.performance-metric {
    display: flex;
    justify-content: space-between;
    padding: 0.25rem 0;
    border-bottom: 1px solid #e0e0e0;
}

.performance-metric:last-child {
    border-bottom: none;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Test runner functions
let testResults = [];

function addTestResult(test, status, message) {
    const result = {
        test: test,
        status: status,
        message: message,
        timestamp: new Date().toLocaleTimeString()
    };
    testResults.push(result);
    displayTestResults();
}

function displayTestResults() {
    const container = document.getElementById('testResults');
    container.innerHTML = testResults.map(result => `
        <div class="test-result test-${result.status}">
            <strong>[${result.timestamp}] ${result.test}:</strong> ${result.message}
        </div>
    `).join('');
    container.scrollTop = container.scrollHeight;
}

function runAllTests() {
    testResults = [];
    addTestResult('Test Suite', 'info', 'Starting mobile settings functionality tests...');
    
    // Run all tests
    setTimeout(() => testTouchTargets(), 100);
    setTimeout(() => testAnimations(), 500);
    setTimeout(() => testFormValidation(), 1000);
    setTimeout(() => testNetworkFunctionality(), 1500);
    setTimeout(() => testPerformance(), 2000);
    setTimeout(() => testAccessibility(), 2500);
    setTimeout(() => {
        addTestResult('Test Suite', 'info', 'All tests completed!');
    }, 3000);
}

function testTouchTargets() {
    addTestResult('Touch Targets', 'info', 'Testing minimum touch target sizes...');
    
    const elements = [
        { id: 'testSwitch1', name: 'Test Switch', minSize: 44 },
        { id: 'testButton1', name: 'Test Button', minSize: 44 },
        { id: 'testSelect1', name: 'Test Select', minSize: 44 }
    ];
    
    elements.forEach(element => {
        const el = document.getElementById(element.id);
        if (el) {
            const rect = el.getBoundingClientRect();
            const width = rect.width;
            const height = rect.height;
            
            if (width >= element.minSize && height >= element.minSize) {
                addTestResult('Touch Targets', 'pass', `${element.name}: ${width}x${height}px (âœ“)`);
            } else {
                addTestResult('Touch Targets', 'fail', `${element.name}: ${width}x${height}px (too small)`);
            }
        }
    });
}

function testAnimations() {
    addTestResult('Animations', 'info', 'Testing animation functionality...');
    
    // Test CSS animation support
    const testEl = document.createElement('div');
    testEl.style.animation = 'test 1s';
    if (testEl.style.animation) {
        addTestResult('Animations', 'pass', 'CSS animations supported');
    } else {
        addTestResult('Animations', 'fail', 'CSS animations not supported');
    }
    
    // Test transition support
    testEl.style.transition = 'all 0.3s';
    if (testEl.style.transition) {
        addTestResult('Animations', 'pass', 'CSS transitions supported');
    } else {
        addTestResult('Animations', 'fail', 'CSS transitions not supported');
    }
}

function testFormValidation() {
    addTestResult('Form Validation', 'info', 'Testing form validation...');
    
    // Test invalid session timeout
    const sessionTimeout = document.getElementById('testSessionTimeout');
    sessionTimeout.value = '999';
    
    // Simulate validation
    if (parseInt(sessionTimeout.value) > 480) {
        addTestResult('Form Validation', 'pass', 'Invalid session timeout detected');
    } else {
        addTestResult('Form Validation', 'fail', 'Invalid session timeout not detected');
    }
}

function testNetworkFunctionality() {
    addTestResult('Network', 'info', 'Testing network functionality...');
    
    // Test CSRF token retrieval
    const csrfToken = getCSRFToken();
    if (csrfToken) {
        addTestResult('Network', 'pass', 'CSRF token retrieved successfully');
    } else {
        addTestResult('Network', 'fail', 'CSRF token not found');
    }
    
    // Test fetch API support
    if (typeof fetch !== 'undefined') {
        addTestResult('Network', 'pass', 'Fetch API supported');
    } else {
        addTestResult('Network', 'fail', 'Fetch API not supported');
    }
}

function testPerformance() {
    addTestResult('Performance', 'info', 'Running performance tests...');
    
    const startTime = performance.now();
    
    // Test DOM manipulation performance
    const testContainer = document.createElement('div');
    for (let i = 0; i < 1000; i++) {
        const el = document.createElement('div');
        el.textContent = `Test element ${i}`;
        testContainer.appendChild(el);
    }
    
    const domTime = performance.now() - startTime;
    
    if (domTime < 100) {
        addTestResult('Performance', 'pass', `DOM manipulation: ${domTime.toFixed(2)}ms (excellent)`);
    } else if (domTime < 500) {
        addTestResult('Performance', 'pass', `DOM manipulation: ${domTime.toFixed(2)}ms (good)`);
    } else {
        addTestResult('Performance', 'fail', `DOM manipulation: ${domTime.toFixed(2)}ms (slow)`);
    }
    
    // Update performance results display
    const performanceContainer = document.getElementById('performanceResults');
    performanceContainer.innerHTML = `
        <div class="performance-metric">
            <span>DOM Manipulation:</span>
            <span>${domTime.toFixed(2)}ms</span>
        </div>
        <div class="performance-metric">
            <span>Memory Usage:</span>
            <span>${(performance.memory ? (performance.memory.usedJSHeapSize / 1024 / 1024).toFixed(2) + 'MB' : 'N/A')}</span>
        </div>
    `;
}

function testAccessibility() {
    addTestResult('Accessibility', 'info', 'Testing accessibility features...');
    
    // Test ARIA labels
    const ariaElements = document.querySelectorAll('[aria-label]');
    if (ariaElements.length > 0) {
        addTestResult('Accessibility', 'pass', `Found ${ariaElements.length} elements with ARIA labels`);
    } else {
        addTestResult('Accessibility', 'fail', 'No ARIA labels found');
    }
    
    // Test keyboard navigation
    const focusableElements = document.querySelectorAll('button, input, select, a[href]');
    if (focusableElements.length > 0) {
        addTestResult('Accessibility', 'pass', `Found ${focusableElements.length} focusable elements`);
    } else {
        addTestResult('Accessibility', 'fail', 'No focusable elements found');
    }
}

// Individual test functions
function testRippleEffect() {
    const button = event.target;
    createRipple({ target: button, clientX: button.offsetLeft + 20, clientY: button.offsetTop + 20 });
    addTestResult('Animation Test', 'info', 'Ripple effect triggered');
}

function testSuccessAnimation() {
    const card = document.querySelector('.mobile-dashboard-card');
    animateSuccess(card);
    addTestResult('Animation Test', 'info', 'Success animation triggered');
}

function testErrorAnimation() {
    const card = document.querySelector('.mobile-dashboard-card');
    animateError(card);
    addTestResult('Animation Test', 'info', 'Error animation triggered');
}

function testLoadingAnimation() {
    setLoadingState(true);
    setTimeout(() => {
        setLoadingState(false);
        addTestResult('Animation Test', 'info', 'Loading animation completed');
    }, 2000);
}

function testSaveSettings() {
    addTestResult('Network Test', 'info', 'Testing save settings API...');
    // This would normally call the actual save function
    // For testing, we'll simulate it
    setTimeout(() => {
        addTestResult('Network Test', 'pass', 'Save settings test completed');
    }, 1000);
}

function testGetSettings() {
    addTestResult('Network Test', 'info', 'Testing get settings API...');
    setTimeout(() => {
        addTestResult('Network Test', 'pass', 'Get settings test completed');
    }, 1000);
}

function testResetSettings() {
    addTestResult('Network Test', 'info', 'Testing reset settings API...');
    setTimeout(() => {
        addTestResult('Network Test', 'pass', 'Reset settings test completed');
    }, 1000);
}

function testNetworkError() {
    addTestResult('Network Test', 'info', 'Testing network error handling...');
    handleNetworkError(new Error('Test network error'), 'test operation');
}

// Include the functions from the main settings page for testing
function getCSRFToken() {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (csrfToken) {
        return csrfToken.value;
    }
    
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
        const [name, value] = cookie.trim().split('=');
        if (name === 'csrftoken') {
            return value;
        }
    }
    return '';
}

function createRipple(event) {
    const element = event.target;
    const rect = element.getBoundingClientRect();
    const size = Math.max(rect.width, rect.height);
    const x = (event.clientX || event.touches?.[0]?.clientX || 0) - rect.left - size / 2;
    const y = (event.clientY || event.touches?.[0]?.clientY || 0) - rect.top - size / 2;
    
    const ripple = document.createElement('div');
    ripple.className = 'ripple';
    ripple.style.width = ripple.style.height = size + 'px';
    ripple.style.left = x + 'px';
    ripple.style.top = y + 'px';
    
    element.appendChild(ripple);
    
    setTimeout(() => {
        ripple.remove();
    }, 600);
}

function animateSuccess(element) {
    element.classList.add('settings-success');
    setTimeout(() => {
        element.classList.remove('settings-success');
    }, 600);
}

function animateError(element) {
    element.classList.add('settings-error');
    setTimeout(() => {
        element.classList.remove('settings-error');
    }, 600);
}

function setLoadingState(isLoading) {
    const buttons = document.querySelectorAll('button');
    buttons.forEach(button => {
        if (isLoading) {
            button.disabled = true;
            button.style.opacity = '0.6';
        } else {
            button.disabled = false;
            button.style.opacity = '';
        }
    });
}

function handleNetworkError(error, operation) {
    console.error(`Error during ${operation}:`, error);
    let message = `Network error during ${operation}: ${error.message}`;
    addTestResult('Network Error', 'fail', message);
}
</script>
{% endblock %}
