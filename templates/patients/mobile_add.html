{% extends 'dashboard/mobile/base.html' %}
{% load static %}

{% block title %}Add Patient - Ethiopian Hospital ERP{% endblock %}

{% block content %}
<!-- Mobile Page Header -->
<div class="mobile-page-header">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h1 class="h4 mb-1">Add New Patient</h1>
            <p class="text-muted mb-0">Register a new patient</p>
        </div>
        <div>
            <a href="{% url 'patients:patient_list' %}?mobile=1" class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-arrow-left"></i>
            </a>
        </div>
    </div>
</div>

<!-- Mobile Form -->
<div class="mobile-dashboard-card">
    <h6 class="text-ethiopia-green mb-3">Patient Information</h6>
    
    <form method="post" class="mobile-form needs-validation" novalidate>
        {% csrf_token %}
        <input type="hidden" name="mobile" value="1">

        <!-- Personal Information -->
        <div class="mobile-form-section">
            <h6 class="mobile-form-section-title">Personal Details</h6>
            
            <div class="row g-3">
                <div class="col-6">
                    <label for="first_name" class="form-label">First Name *</label>
                    <input type="text" class="form-control" id="first_name" name="first_name" required>
                    <div class="invalid-feedback">Please provide a first name.</div>
                </div>
                <div class="col-6">
                    <label for="last_name" class="form-label">Last Name *</label>
                    <input type="text" class="form-control" id="last_name" name="last_name" required>
                    <div class="invalid-feedback">Please provide a last name.</div>
                </div>
                <div class="col-12">
                    <label for="date_of_birth" class="form-label">Date of Birth *</label>
                    <input type="date" class="form-control" id="date_of_birth" name="date_of_birth" required>
                    <div class="invalid-feedback">Please provide a valid date of birth.</div>
                </div>
                <div class="col-6">
                    <label for="gender" class="form-label">Gender *</label>
                    <select class="form-select" id="gender" name="gender" required>
                        <option value="">Select Gender</option>
                        <option value="M">Male</option>
                        <option value="F">Female</option>
                        <option value="O">Other</option>
                    </select>
                    <div class="invalid-feedback">Please select a gender.</div>
                </div>
                <div class="col-6">
                    <label for="blood_type" class="form-label">Blood Type</label>
                    <select class="form-select" id="blood_type" name="blood_type">
                        <option value="">Select Blood Type</option>
                        <option value="A+">A+</option>
                        <option value="A-">A-</option>
                        <option value="B+">B+</option>
                        <option value="B-">B-</option>
                        <option value="AB+">AB+</option>
                        <option value="AB-">AB-</option>
                        <option value="O+">O+</option>
                        <option value="O-">O-</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Contact Information -->
        <div class="mobile-form-section">
            <h6 class="mobile-form-section-title">Contact Information</h6>
            
            <div class="row g-3">
                <div class="col-12">
                    <label for="phone" class="form-label">Phone Number *</label>
                    <input type="tel" class="form-control" id="phone" name="phone" placeholder="+251..." required>
                    <div class="invalid-feedback">Please provide a valid phone number.</div>
                </div>
                <div class="col-12">
                    <label for="email" class="form-label">Email Address</label>
                    <input type="email" class="form-control" id="email" name="email" placeholder="patient@example.com">
                    <div class="invalid-feedback">Please provide a valid email address.</div>
                </div>
                <div class="col-6">
                    <label for="kebele" class="form-label">Kebele *</label>
                    <input type="text" class="form-control" id="kebele" name="kebele" placeholder="Kebele" required>
                    <div class="invalid-feedback">Please provide kebele.</div>
                </div>
                <div class="col-6">
                    <label for="woreda" class="form-label">Woreda *</label>
                    <input type="text" class="form-control" id="woreda" name="woreda" placeholder="Woreda" required>
                    <div class="invalid-feedback">Please provide woreda.</div>
                </div>
                <div class="col-6">
                    <label for="city" class="form-label">City</label>
                    <input type="text" class="form-control" id="city" name="city" placeholder="Addis Ababa" value="Addis Ababa">
                </div>
                <div class="col-6">
                    <label for="region" class="form-label">Region</label>
                    <input type="text" class="form-control" id="region" name="region" placeholder="Addis Ababa" value="Addis Ababa">
                </div>
                <div class="col-12">
                    <label for="address" class="form-label">Address</label>
                    <textarea class="form-control" id="address" name="address" rows="3" placeholder="Street address, additional details"></textarea>
                </div>
            </div>
        </div>

        <!-- Emergency Contact -->
        <div class="mobile-form-section">
            <h6 class="mobile-form-section-title">Emergency Contact</h6>
            
            <div class="row g-3">
                <div class="col-12">
                    <label for="emergency_contact_name" class="form-label">Contact Name *</label>
                    <input type="text" class="form-control" id="emergency_contact_name" name="emergency_contact_name" placeholder="Full name" required>
                    <div class="invalid-feedback">Please provide emergency contact name.</div>
                </div>
                <div class="col-6">
                    <label for="emergency_contact_phone" class="form-label">Contact Phone *</label>
                    <input type="tel" class="form-control" id="emergency_contact_phone" name="emergency_contact_phone" placeholder="+251..." required>
                    <div class="invalid-feedback">Please provide emergency contact phone.</div>
                </div>
                <div class="col-6">
                    <label for="emergency_contact_relationship" class="form-label">Relationship *</label>
                    <select class="form-select" id="emergency_contact_relationship" name="emergency_contact_relationship" required>
                        <option value="">Select Relationship</option>
                        <option value="spouse">Spouse</option>
                        <option value="parent">Parent</option>
                        <option value="child">Child</option>
                        <option value="sibling">Sibling</option>
                        <option value="friend">Friend</option>
                        <option value="other">Other</option>
                    </select>
                    <div class="invalid-feedback">Please select relationship.</div>
                </div>
            </div>
        </div>

        <!-- Medical Information -->
        <div class="mobile-form-section">
            <h6 class="mobile-form-section-title">Medical Information</h6>
            
            <div class="row g-3">
                <div class="col-12">
                    <label for="allergies" class="form-label">Known Allergies</label>
                    <textarea class="form-control" id="allergies" name="allergies" rows="2" placeholder="List any known allergies..."></textarea>
                </div>
                <div class="col-12">
                    <label for="medical_history" class="form-label">Medical History</label>
                    <textarea class="form-control" id="medical_history" name="medical_history" rows="3" placeholder="Previous medical conditions, surgeries, etc."></textarea>
                </div>
                <div class="col-12">
                    <label for="current_medications" class="form-label">Current Medications</label>
                    <textarea class="form-control" id="current_medications" name="current_medications" rows="2" placeholder="List current medications..."></textarea>
                </div>
            </div>
        </div>

        <!-- Form Actions -->
        <div class="mobile-form-actions">
            <div class="row g-2">
                <div class="col-6">
                    <a href="{% url 'patients:patient_list' %}?mobile=1" class="btn btn-outline-secondary w-100">
                        <i class="fas fa-times me-2"></i>Cancel
                    </a>
                </div>
                <div class="col-6">
                    <button type="submit" class="btn btn-primary w-100 mobile-add-patient-btn">
                        <i class="fas fa-save me-2"></i>
                        <span class="mobile-btn-text">Save Patient</span>
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_css %}
<style>
.mobile-form {
    max-width: 100%;
}

.mobile-form-section {
    margin-bottom: 2rem;
    padding-bottom: 1.5rem;
    border-bottom: 1px solid rgba(0, 150, 57, 0.1);
}

.mobile-form-section:last-of-type {
    border-bottom: none;
    margin-bottom: 1rem;
}

.mobile-form-section-title {
    color: var(--mobile-primary);
    font-weight: 600;
    margin-bottom: 1rem;
    font-size: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.mobile-form-section-title::before {
    content: '';
    width: 4px;
    height: 20px;
    background: var(--mobile-primary);
    border-radius: 2px;
}

.form-label {
    font-weight: 500;
    color: var(--mobile-secondary);
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
}

.form-control,
.form-select {
    border: 2px solid rgba(0, 150, 57, 0.2);
    border-radius: 8px;
    padding: 12px 16px;
    font-size: 16px; /* Prevent zoom on iOS */
    transition: all var(--mobile-transition-fast);
    min-height: var(--mobile-touch-target);
}

.form-control:focus,
.form-select:focus {
    border-color: var(--mobile-primary);
    box-shadow: 0 0 0 3px rgba(0, 150, 57, 0.1);
    outline: none;
}

.form-control.is-invalid,
.form-select.is-invalid {
    border-color: var(--mobile-danger);
}

.invalid-feedback {
    display: block;
    color: var(--mobile-danger);
    font-size: 0.8rem;
    margin-top: 0.25rem;
}

.mobile-form-actions {
    margin-top: 2rem;
    padding-top: 1.5rem;
    border-top: 1px solid rgba(0, 150, 57, 0.1);
}

.mobile-form-actions .btn {
    min-height: var(--mobile-touch-target);
    font-weight: 500;
    border-radius: 8px;
}

/* Responsive adjustments */
@media (max-width: 375px) {
    .mobile-form-section {
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
    }
    
    .mobile-form-section-title {
        font-size: 0.9rem;
    }
    
    .form-control,
    .form-select {
        padding: 10px 14px;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Form validation
    const form = document.querySelector('.needs-validation');
    if (form) {
        form.addEventListener('submit', function(event) {
            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
                
                // Show mobile notification
                if (window.mobileDashboard) {
                    mobileDashboard.showMobileNotification('Please fill in all required fields', 'danger');
                }
            }
            form.classList.add('was-validated');
        }, false);
    }
    
    // Auto-generate patient ID
    const firstNameInput = document.getElementById('first_name');
    const lastNameInput = document.getElementById('last_name');
    
    function generatePatientId() {
        const firstName = firstNameInput.value.trim();
        const lastName = lastNameInput.value.trim();
        
        if (firstName && lastName) {
            const timestamp = Date.now().toString().slice(-4);
            const initials = (firstName.charAt(0) + lastName.charAt(0)).toUpperCase();
            const patientId = `PAT-${initials}${timestamp}`;
            
            // You can use this patient ID if needed
            console.log('Generated Patient ID:', patientId);
        }
    }
    
    if (firstNameInput && lastNameInput) {
        firstNameInput.addEventListener('blur', generatePatientId);
        lastNameInput.addEventListener('blur', generatePatientId);
    }
    
    // Phone number formatting
    const phoneInput = document.getElementById('phone');
    if (phoneInput) {
        phoneInput.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.startsWith('251')) {
                value = '+' + value;
            } else if (value.startsWith('0')) {
                value = '+251' + value.substring(1);
            } else if (!value.startsWith('+251') && value.length > 0) {
                value = '+251' + value;
            }
            e.target.value = value;
        });
    }
    
    // Show success notification on form submission
    if (window.mobileDashboard) {
        mobileDashboard.showMobileNotification('Patient form loaded successfully!', 'info');
    }
});
</script>
{% endblock %}
