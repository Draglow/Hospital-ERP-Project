{% extends "base_mobile.html" %}
{% load static %}

{% block title %}Mobile Notification Action Buttons Test{% endblock %}

{% block content %}
<div class="mobile-page-header">
    <h4 class="mobile-page-title">
        <i class="fas fa-cog me-2 text-ethiopia-green"></i>
        Action Buttons Test
    </h4>
    <p class="mobile-page-subtitle">Testing notification card action button functionality</p>
</div>

<!-- Test Notification Cards -->
<div class="mobile-notifications-list">
    <!-- Test Case 1: Unread notification with both buttons -->
    <div class="mobile-notification-card unread" data-notification-id="test-1">
        <div class="mobile-notification-header">
            <div class="mobile-notification-icon">
                <i class="fas fa-info-circle text-ethiopia-green"></i>
            </div>
            <div class="mobile-notification-meta">
                <div class="mobile-notification-type">
                    <span class="badge bg-secondary">System</span>
                    <span class="badge bg-normal">Normal</span>
                </div>
                <div class="mobile-notification-time">
                    <small class="text-muted">2 min ago</small>
                </div>
            </div>
            <div class="mobile-notification-header-actions">
                <button class="mobile-notification-action-btn mobile-mark-as-read"
                        data-notification-id="test-1"
                        aria-label="Mark as read">
                    <i class="fas fa-check"></i>
                </button>
                <button class="mobile-notification-action-btn mobile-delete-notification"
                        data-notification-id="test-1"
                        aria-label="Delete notification">
                    <i class="fas fa-trash"></i>
                </button>
                <div class="mobile-notification-unread-indicator">
                    <span class="badge bg-ethiopia-green rounded-pill"></span>
                </div>
            </div>
        </div>

        <div class="mobile-notification-content">
            <h6 class="mobile-notification-title">Test Notification</h6>
            <p class="mobile-notification-message">This is a test message</p>
        </div>
    </div>

    <!-- Test Case 2: Read notification with delete button only -->
    <div class="mobile-notification-card" data-notification-id="test-2">
        <div class="mobile-notification-header">
            <div class="mobile-notification-icon">
                <i class="fas fa-calendar-alt text-ethiopia-green"></i>
            </div>
            <div class="mobile-notification-meta">
                <div class="mobile-notification-type">
                    <span class="badge bg-secondary">Appointment</span>
                    <span class="badge bg-high">High</span>
                </div>
                <div class="mobile-notification-time">
                    <small class="text-muted">5 min ago</small>
                </div>
            </div>
            <div class="mobile-notification-header-actions">
                <button class="mobile-notification-action-btn mobile-delete-notification"
                        data-notification-id="test-2"
                        aria-label="Delete notification">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>

        <div class="mobile-notification-content">
            <h6 class="mobile-notification-title">Read Notification</h6>
            <p class="mobile-notification-message">Already read message</p>
        </div>
    </div>

    <!-- Test Case 3: Urgent notification -->
    <div class="mobile-notification-card urgent unread" data-notification-id="test-3">
        <div class="mobile-notification-header">
            <div class="mobile-notification-icon">
                <i class="fas fa-exclamation-triangle text-ethiopia-green"></i>
            </div>
            <div class="mobile-notification-meta">
                <div class="mobile-notification-type">
                    <span class="badge bg-secondary">System</span>
                    <span class="badge bg-urgent">Urgent</span>
                </div>
                <div class="mobile-notification-time">
                    <small class="text-muted">1 min ago</small>
                </div>
            </div>
            <div class="mobile-notification-header-actions">
                <button class="mobile-notification-action-btn mobile-mark-as-read"
                        data-notification-id="test-3"
                        aria-label="Mark as read">
                    <i class="fas fa-check"></i>
                </button>
                <button class="mobile-notification-action-btn mobile-delete-notification"
                        data-notification-id="test-3"
                        aria-label="Delete notification">
                    <i class="fas fa-trash"></i>
                </button>
                <div class="mobile-notification-unread-indicator">
                    <span class="badge bg-ethiopia-green rounded-pill"></span>
                </div>
            </div>
        </div>

        <div class="mobile-notification-content">
            <h6 class="mobile-notification-title">Urgent Alert!</h6>
            <p class="mobile-notification-message">Urgent test message</p>
        </div>
    </div>
</div>

<!-- Test Controls -->
<div class="mobile-dashboard-card mt-4">
    <h6 class="text-ethiopia-blue mb-3">
        <i class="fas fa-tools me-2"></i>Test Controls
    </h6>
    
    <div class="row g-2">
        <div class="col-6">
            <button class="btn btn-outline-primary btn-sm w-100" onclick="testButtonVisibility()">
                <i class="fas fa-eye me-1"></i>Check Visibility
            </button>
        </div>
        <div class="col-6">
            <button class="btn btn-outline-success btn-sm w-100" onclick="testButtonSizing()">
                <i class="fas fa-ruler me-1"></i>Check Sizing
            </button>
        </div>
        <div class="col-6">
            <button class="btn btn-outline-warning btn-sm w-100" onclick="testTouchTargets()">
                <i class="fas fa-hand-pointer me-1"></i>Touch Targets
            </button>
        </div>
        <div class="col-6">
            <button class="btn btn-outline-info btn-sm w-100" onclick="runAllButtonTests()">
                <i class="fas fa-play me-1"></i>Run All Tests
            </button>
        </div>
    </div>
</div>

<!-- Test Results -->
<div class="mobile-dashboard-card mt-3">
    <h6 class="text-ethiopia-green mb-3">
        <i class="fas fa-clipboard-check me-2"></i>Test Results
    </h6>
    <div id="test-results" class="test-results-container">
        <p class="text-muted">Click "Run All Tests" to see results...</p>
    </div>
</div>

<!-- Mock API Responses -->
<div class="mobile-dashboard-card mt-3">
    <h6 class="text-ethiopia-yellow mb-3">
        <i class="fas fa-server me-2"></i>Mock API Controls
    </h6>
    <div class="row g-2">
        <div class="col-6">
            <button class="btn btn-outline-success btn-sm w-100" onclick="setMockSuccess()">
                <i class="fas fa-check me-1"></i>Mock Success
            </button>
        </div>
        <div class="col-6">
            <button class="btn btn-outline-danger btn-sm w-100" onclick="setMockError()">
                <i class="fas fa-times me-1"></i>Mock Error
            </button>
        </div>
    </div>
    <p class="small text-muted mt-2">Current mode: <span id="mock-mode">Success</span></p>
</div>

<!-- Back to Notifications -->
<div class="mobile-bottom-actions">
    <a href="{% url 'notifications:notification_list' %}?mobile=1" class="btn btn-outline-primary">
        <i class="fas fa-arrow-left me-2"></i>Back to Notifications
    </a>
</div>

<!-- CSRF Token for AJAX requests -->
{% csrf_token %}
{% endblock %}

{% block extra_css %}
<style>
/* Test-specific styles */
.test-results-container {
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: var(--mobile-spacing-md);
    background: #f8f9fa;
}

.test-result-item {
    padding: var(--mobile-spacing-sm);
    margin-bottom: var(--mobile-spacing-xs);
    border-radius: 6px;
    font-size: 0.85rem;
}

.test-result-item.success {
    background: rgba(40, 167, 69, 0.1);
    border-left: 3px solid #28a745;
}

.test-result-item.warning {
    background: rgba(255, 193, 7, 0.1);
    border-left: 3px solid #ffc107;
}

.test-result-item.error {
    background: rgba(220, 53, 69, 0.1);
    border-left: 3px solid #dc3545;
}

.test-result-item.info {
    background: rgba(0, 123, 255, 0.1);
    border-left: 3px solid #007bff;
}

/* Highlight test elements */
.mobile-notification-action-btn.test-highlight {
    box-shadow: 0 0 0 2px #007bff !important;
    animation: testHighlight 2s ease-in-out;
}

@keyframes testHighlight {
    0%, 100% { box-shadow: 0 0 0 2px #007bff; }
    50% { box-shadow: 0 0 0 4px rgba(0, 123, 255, 0.5); }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Mock API mode
let mockApiMode = 'success';

function setMockSuccess() {
    mockApiMode = 'success';
    document.getElementById('mock-mode').textContent = 'Success';
    addTestResult('Mock API', 'success', 'Set to success mode');
}

function setMockError() {
    mockApiMode = 'error';
    document.getElementById('mock-mode').textContent = 'Error';
    addTestResult('Mock API', 'error', 'Set to error mode');
}

// Override fetch for testing
const originalFetch = window.fetch;
window.fetch = function(url, options) {
    if (url.includes('/notifications/')) {
        return new Promise((resolve, reject) => {
            setTimeout(() => {
                if (mockApiMode === 'success') {
                    resolve({
                        ok: true,
                        json: () => Promise.resolve({
                            success: true,
                            message: 'Test operation successful'
                        })
                    });
                } else {
                    reject(new Error('Mock API error for testing'));
                }
            }, 1000); // Simulate network delay
        });
    }
    return originalFetch.apply(this, arguments);
};

function testButtonVisibility() {
    const buttons = document.querySelectorAll('.mobile-notification-action-btn');
    let results = [];
    
    buttons.forEach((btn, index) => {
        const rect = btn.getBoundingClientRect();
        const isVisible = rect.width > 0 && rect.height > 0;
        const computedStyle = window.getComputedStyle(btn);
        const isDisplayed = computedStyle.display !== 'none';
        const opacity = parseFloat(computedStyle.opacity);
        
        results.push({
            test: `Button ${index + 1} Visibility`,
            passed: isVisible && isDisplayed && opacity > 0,
            details: `Visible: ${isVisible}, Displayed: ${isDisplayed}, Opacity: ${opacity}`
        });
        
        // Highlight button for visual feedback
        btn.classList.add('test-highlight');
        setTimeout(() => btn.classList.remove('test-highlight'), 2000);
    });
    
    displayTestResults(results, 'Button Visibility Tests');
}

function testButtonSizing() {
    const buttons = document.querySelectorAll('.mobile-notification-action-btn');
    let results = [];
    
    buttons.forEach((btn, index) => {
        const rect = btn.getBoundingClientRect();
        const minTouchTarget = 32; // Minimum for mobile
        const idealTouchTarget = 44; // Ideal for mobile
        
        const widthOk = rect.width >= minTouchTarget;
        const heightOk = rect.height >= minTouchTarget;
        const isIdeal = rect.width >= idealTouchTarget && rect.height >= idealTouchTarget;
        
        results.push({
            test: `Button ${index + 1} Sizing`,
            passed: widthOk && heightOk,
            details: `${rect.width.toFixed(0)}x${rect.height.toFixed(0)}px ${isIdeal ? '(Ideal)' : '(Minimum)'}`
        });
    });
    
    displayTestResults(results, 'Button Sizing Tests');
}

function testTouchTargets() {
    const buttons = document.querySelectorAll('.mobile-notification-action-btn');
    let results = [];
    
    buttons.forEach((btn, index) => {
        const rect = btn.getBoundingClientRect();
        const touchArea = rect.width * rect.height;
        const minTouchArea = 32 * 32; // 1024 sq px
        const idealTouchArea = 44 * 44; // 1936 sq px
        
        const isAccessible = touchArea >= minTouchArea;
        const isIdeal = touchArea >= idealTouchArea;
        
        results.push({
            test: `Button ${index + 1} Touch Target`,
            passed: isAccessible,
            details: `${touchArea.toFixed(0)} sq px ${isIdeal ? '(Ideal)' : isAccessible ? '(Accessible)' : '(Too Small)'}`
        });
    });
    
    displayTestResults(results, 'Touch Target Tests');
}

function runAllButtonTests() {
    clearTestResults();
    addTestResult('Test Suite', 'info', 'Running all action button tests...');
    
    setTimeout(() => testButtonVisibility(), 500);
    setTimeout(() => testButtonSizing(), 1000);
    setTimeout(() => testTouchTargets(), 1500);
    
    setTimeout(() => {
        addTestResult('Test Suite', 'success', 'All button tests completed!');
        if (window.mobileDashboard) {
            mobileDashboard.showMobileNotification('Tests completed!', 'success');
        }
    }, 2000);
}

function displayTestResults(results, suiteName) {
    addTestResult(suiteName, 'info', `Running ${results.length} tests...`);
    
    results.forEach(result => {
        const status = result.passed ? 'success' : 'error';
        addTestResult(result.test, status, result.details);
    });
}

function addTestResult(testName, status, message) {
    const container = document.getElementById('test-results');
    const resultItem = document.createElement('div');
    resultItem.className = `test-result-item ${status}`;
    
    const timestamp = new Date().toLocaleTimeString();
    resultItem.innerHTML = `
        <strong>${testName}</strong> <small class="text-muted">[${timestamp}]</small><br>
        <span>${message}</span>
    `;
    
    container.appendChild(resultItem);
    container.scrollTop = container.scrollHeight;
}

function clearTestResults() {
    const container = document.getElementById('test-results');
    container.innerHTML = '';
}

// Initialize test page
document.addEventListener('DOMContentLoaded', function() {
    console.log('Mobile notification action buttons test page loaded');
    
    if (window.mobileDashboard) {
        mobileDashboard.showMobileNotification('Test page loaded!', 'info');
    }
    
    // Set up test notification event listeners
    setupTestNotificationListeners();
    
    // Auto-run basic tests
    setTimeout(() => {
        addTestResult('Page Load', 'info', 'Test page loaded successfully');
        testButtonVisibility();
    }, 1000);
});

function setupTestNotificationListeners() {
    // Mark as read buttons
    document.querySelectorAll('.mobile-mark-as-read').forEach(button => {
        button.addEventListener('click', function(e) {
            e.stopPropagation();
            const notificationId = this.dataset.notificationId;
            addTestResult('Mark as Read', 'info', `Testing mark as read for ${notificationId}`);
            markNotificationAsRead(notificationId, this);
        });
    });

    // Delete buttons
    document.querySelectorAll('.mobile-delete-notification').forEach(button => {
        button.addEventListener('click', function(e) {
            e.stopPropagation();
            const notificationId = this.dataset.notificationId;
            addTestResult('Delete', 'info', `Testing delete for ${notificationId}`);
            deleteNotification(notificationId, this);
        });
    });
}

// Include the notification functions from the main template
// (These would normally be loaded from the main mobile_list.html)
</script>
{% endblock %}
