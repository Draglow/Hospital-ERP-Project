{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}Edit Medicine - Ethiopian Hospital ERP{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 mb-0 text-gray-800">Edit Medicine</h1>
        <p class="text-muted">Update medicine information and inventory details</p>
    </div>
    <div class="d-flex gap-2">
        <a href="{% url 'pharmacy:medicine_detail' medicine.pk %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Back to Details
        </a>
        <a href="{% url 'pharmacy:medicine_list' %}" class="btn btn-outline-primary">
            <i class="fas fa-list me-2"></i>All Medicines
        </a>
    </div>
</div>

<!-- Edit Form -->
<div class="row g-4">
    <div class="col-lg-8">
        <div class="dashboard-card">
            <h5 class="card-title mb-4">
                <i class="fas fa-edit text-ethiopia-green me-2"></i>Medicine Information
            </h5>
            
            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}
                
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Medicine Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="name" value="{{ medicine.name }}" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Generic Name</label>
                        <input type="text" class="form-control" name="generic_name" value="{{ medicine.generic_name|default:'' }}">
                    </div>
                    
                    <div class="col-md-6">
                        <label class="form-label">Category <span class="text-danger">*</span></label>
                        <select class="form-select" name="category" required>
                            <option value="">Select Category</option>
                            {% for value, label in categories %}
                                <option value="{{ value }}" {% if medicine.category == value %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Form <span class="text-danger">*</span></label>
                        <select class="form-select" name="form" required>
                            <option value="">Select Form</option>
                            {% for value, label in forms %}
                                <option value="{{ value }}" {% if medicine.form == value %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="col-md-6">
                        <label class="form-label">Strength</label>
                        <input type="text" class="form-control" name="strength" value="{{ medicine.strength|default:'' }}" placeholder="e.g., 500mg">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Manufacturer</label>
                        <input type="text" class="form-control" name="manufacturer" value="{{ medicine.manufacturer|default:'' }}">
                    </div>
                    
                    <div class="col-md-4">
                        <label class="form-label">Unit Price (ETB) <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <span class="input-group-text">Br</span>
                            <input type="number" class="form-control" name="unit_price" value="{{ medicine.unit_price }}" step="0.01" min="0" required>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Stock Quantity <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" name="stock_quantity" value="{{ medicine.stock_quantity }}" min="0" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Minimum Stock Level</label>
                        <input type="number" class="form-control" name="minimum_stock_level" value="{{ medicine.minimum_stock_level|default:10 }}" min="0">
                    </div>
                    
                    <div class="col-md-6">
                        <label class="form-label">Expiry Date</label>
                        <input type="date" class="form-control" name="expiry_date" value="{{ medicine.expiry_date|date:'Y-m-d' }}">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Batch Number</label>
                        <input type="text" class="form-control" name="batch_number" value="{{ medicine.batch_number|default:'' }}">
                    </div>
                    
                    <div class="col-12">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" name="description" rows="3" placeholder="Medicine description, usage instructions, etc.">{{ medicine.description|default:'' }}</textarea>
                    </div>
                    
                    <div class="col-12">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="requires_prescription" id="requiresPrescription" {% if medicine.requires_prescription %}checked{% endif %}>
                            <label class="form-check-label" for="requiresPrescription">
                                Requires Prescription
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="d-flex gap-2 mt-4">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Update Medicine
                    </button>
                    <a href="{% url 'pharmacy:medicine_detail' medicine.pk %}" class="btn btn-secondary">
                        <i class="fas fa-times me-2"></i>Cancel
                    </a>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Current Status -->
        <div class="dashboard-card mb-4">
            <h6 class="text-ethiopia-green mb-3">
                <i class="fas fa-info-circle me-2"></i>Current Status
            </h6>
            
            <div class="mb-3">
                <small class="text-muted">Stock Status</small>
                <div class="d-flex align-items-center">
                    {% if medicine.stock_quantity <= medicine.minimum_stock_level %}
                        <span class="badge bg-danger me-2">Low Stock</span>
                    {% elif medicine.stock_quantity <= 50 %}
                        <span class="badge bg-warning me-2">Medium Stock</span>
                    {% else %}
                        <span class="badge bg-success me-2">In Stock</span>
                    {% endif %}
                    <span class="fw-bold">{{ medicine.stock_quantity }} units</span>
                </div>
            </div>
            
            <div class="mb-3">
                <small class="text-muted">Expiry Status</small>
                <div>
                    {% if medicine.expiry_date %}
                        {% if medicine.is_expired %}
                            <span class="badge bg-danger">Expired</span>
                        {% elif medicine.expires_soon %}
                            <span class="badge bg-warning">Expires Soon</span>
                        {% else %}
                            <span class="badge bg-success">Valid</span>
                        {% endif %}
                    {% else %}
                        <span class="badge bg-secondary">No Expiry Date</span>
                    {% endif %}
                </div>
            </div>
            
            <div>
                <small class="text-muted">Last Updated</small>
                <div class="fw-bold">{{ medicine.updated_at|date:"M d, Y" }}</div>
            </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="dashboard-card">
            <h6 class="text-ethiopia-green mb-3">
                <i class="fas fa-bolt me-2"></i>Quick Actions
            </h6>
            <div class="d-grid gap-2">
                <button class="btn btn-outline-primary btn-sm" onclick="adjustStock()">
                    <i class="fas fa-plus-minus me-2"></i>Adjust Stock
                </button>
                <button class="btn btn-outline-info btn-sm" onclick="viewHistory()">
                    <i class="fas fa-history me-2"></i>View History
                </button>
                <button class="btn btn-outline-warning btn-sm" onclick="generateBarcode()">
                    <i class="fas fa-barcode me-2"></i>Generate Barcode
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function adjustStock() {
    // Show stock adjustment modal
    alert('Stock adjustment feature coming soon!');
}

function viewHistory() {
    // Show medicine history
    alert('Medicine history feature coming soon!');
}

function generateBarcode() {
    // Generate barcode for medicine
    alert('Barcode generation feature coming soon!');
}

// Form validation
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    form.addEventListener('submit', function(e) {
        const name = document.querySelector('input[name="name"]').value.trim();
        const category = document.querySelector('select[name="category"]').value;
        const form_type = document.querySelector('select[name="form"]').value;
        const price = document.querySelector('input[name="unit_price"]').value;
        const stock = document.querySelector('input[name="stock_quantity"]').value;
        
        if (!name || !category || !form_type || !price || !stock) {
            e.preventDefault();
            alert('Please fill in all required fields.');
            return false;
        }
        
        if (parseFloat(price) <= 0) {
            e.preventDefault();
            alert('Unit price must be greater than 0.');
            return false;
        }
        
        if (parseInt(stock) < 0) {
            e.preventDefault();
            alert('Stock quantity cannot be negative.');
            return false;
        }
    });
});
</script>
{% endblock %}
