{% extends 'dashboard/mobile/base.html' %}
{% load static %}

{% block title %}Mobile Responsive Test - Ethiopian Hospital ERP{% endblock %}

{% block content %}
<!-- Mobile Test Header -->
<div class="mobile-page-header">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h1 class="h4 mb-1">Mobile Responsive Test</h1>
            <p class="text-muted mb-0">Testing mobile dashboard responsiveness</p>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-sm btn-outline-primary" onclick="runMobileTests()">
                <i class="fas fa-play"></i>
            </button>
            <button class="btn btn-sm btn-primary" onclick="toggleMobileSidebar()">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </div>
</div>

<!-- Device Information -->
<div class="mobile-dashboard-card mb-3">
    <h6 class="text-ethiopia-green mb-3">📱 Device Information</h6>
    <div id="mobileDeviceInfo">
        <p><strong>Screen Width:</strong> <span id="mobileScreenWidth"></span>px</p>
        <p><strong>Device Type:</strong> <span id="mobileDeviceType"></span></p>
        <p><strong>Orientation:</strong> <span id="mobileOrientation"></span></p>
        <p><strong>Viewport:</strong> <span id="mobileViewport"></span></p>
        <p><strong>User Agent:</strong> <span id="mobileUserAgent"></span></p>
    </div>
</div>

<!-- Mobile Test Cards Grid -->
<div class="row g-3 mb-4">
    <div class="col-6 col-md-3">
        <div class="mobile-dashboard-card mobile-stat-card">
            <div class="mobile-stat-icon">
                <i class="fas fa-mobile-alt text-ethiopia-green"></i>
            </div>
            <div class="mobile-stat-number">100%</div>
            <div class="mobile-stat-label">Mobile Optimized</div>
            <div class="mobile-stat-change">
                <small class="text-success">
                    <i class="fas fa-check-circle"></i>
                    Responsive
                </small>
            </div>
        </div>
    </div>

    <div class="col-6 col-md-3">
        <div class="mobile-dashboard-card mobile-stat-card">
            <div class="mobile-stat-icon">
                <i class="fas fa-hand-pointer text-ethiopia-blue"></i>
            </div>
            <div class="mobile-stat-number">44px</div>
            <div class="mobile-stat-label">Touch Targets</div>
            <div class="mobile-stat-change">
                <small class="text-success">
                    <i class="fas fa-thumbs-up"></i>
                    Accessible
                </small>
            </div>
        </div>
    </div>

    <div class="col-6 col-md-3">
        <div class="mobile-dashboard-card mobile-stat-card">
            <div class="mobile-stat-icon">
                <i class="fas fa-tachometer-alt text-ethiopia-yellow"></i>
            </div>
            <div class="mobile-stat-number">Fast</div>
            <div class="mobile-stat-label">Performance</div>
            <div class="mobile-stat-change">
                <small class="text-success">
                    <i class="fas fa-rocket"></i>
                    Optimized
                </small>
            </div>
        </div>
    </div>

    <div class="col-6 col-md-3">
        <div class="mobile-dashboard-card mobile-stat-card">
            <div class="mobile-stat-icon">
                <i class="fas fa-palette text-ethiopia-red"></i>
            </div>
            <div class="mobile-stat-number">PWA</div>
            <div class="mobile-stat-label">App-like</div>
            <div class="mobile-stat-change">
                <small class="text-success">
                    <i class="fas fa-star"></i>
                    Native Feel
                </small>
            </div>
        </div>
    </div>
</div>

<!-- Mobile Features Test -->
<div class="mobile-dashboard-card mb-3">
    <h6 class="text-ethiopia-green mb-3">🧪 Mobile Features Test</h6>
    <div class="row g-2">
        <div class="col-6">
            <button class="btn btn-outline-primary w-100" onclick="testMobileSearch()">
                <i class="fas fa-search me-2"></i>Test Search
            </button>
        </div>
        <div class="col-6">
            <button class="btn btn-outline-success w-100" onclick="testMobileNotifications()">
                <i class="fas fa-bell me-2"></i>Test Notifications
            </button>
        </div>
        <div class="col-6">
            <button class="btn btn-outline-info w-100" onclick="testMobileProfile()">
                <i class="fas fa-user me-2"></i>Test Profile
            </button>
        </div>
        <div class="col-6">
            <button class="btn btn-outline-warning w-100" onclick="testMobileGestures()">
                <i class="fas fa-hand-paper me-2"></i>Test Gestures
            </button>
        </div>
    </div>
</div>

<!-- Mobile Navigation Test -->
<div class="mobile-dashboard-card mb-3">
    <h6 class="text-ethiopia-green mb-3">🧭 Mobile Navigation Test</h6>
    <div class="row g-2">
        <div class="col-6">
            <a href="{% url 'patients:patient_list' %}?mobile=1" class="btn btn-outline-primary w-100">
                <i class="fas fa-users me-2"></i>Test Patients
            </a>
        </div>
        <div class="col-6">
            <a href="{% url 'appointments:appointment_list' %}?mobile=1" class="btn btn-outline-success w-100">
                <i class="fas fa-calendar me-2"></i>Test Appointments
            </a>
        </div>
        <div class="col-6">
            <a href="{% url 'doctors:doctor_list' %}?mobile=1" class="btn btn-outline-info w-100">
                <i class="fas fa-user-md me-2"></i>Test Doctors
            </a>
        </div>
        <div class="col-6">
            <a href="{% url 'billing:invoice_list' %}?mobile=1" class="btn btn-outline-warning w-100">
                <i class="fas fa-file-invoice me-2"></i>Test Billing
            </a>
        </div>
        <div class="col-12">
            <a href="{% url 'pharmacy:medicine_list' %}?mobile=1" class="btn btn-outline-secondary w-100">
                <i class="fas fa-pills me-2"></i>Test Pharmacy
            </a>
        </div>
    </div>
    <div class="mt-3">
        <small class="text-muted">
            <i class="fas fa-info-circle me-1"></i>
            These links should all stay within the mobile interface and not redirect to desktop versions.
        </small>
    </div>
</div>

<!-- Mobile Chart Test -->
<div class="mobile-dashboard-card mb-3">
    <h6 class="text-ethiopia-green mb-3">📊 Mobile Chart Test</h6>
    <div class="mobile-chart-container">
        <canvas id="mobileTestChart"></canvas>
    </div>
</div>

<!-- Mobile Table Test -->
<div class="mobile-dashboard-card mb-3">
    <h6 class="text-ethiopia-green mb-3">📋 Mobile Table Test</h6>
    <div class="mobile-table-container">
        <table class="mobile-table">
            <thead>
                <tr>
                    <th>Feature</th>
                    <th>Status</th>
                    <th>Performance</th>
                    <th>Score</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Touch Targets</td>
                    <td><span class="badge bg-success">✓ Pass</span></td>
                    <td>Excellent</td>
                    <td>100%</td>
                </tr>
                <tr>
                    <td>Responsive Layout</td>
                    <td><span class="badge bg-success">✓ Pass</span></td>
                    <td>Excellent</td>
                    <td>100%</td>
                </tr>
                <tr>
                    <td>Mobile Navigation</td>
                    <td><span class="badge bg-success">✓ Pass</span></td>
                    <td>Excellent</td>
                    <td>100%</td>
                </tr>
                <tr>
                    <td>Performance</td>
                    <td><span class="badge bg-success">✓ Pass</span></td>
                    <td>Fast</td>
                    <td>95%</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Test Results -->
<div class="mobile-dashboard-card">
    <h6 class="text-ethiopia-green mb-3">🎯 Test Results</h6>
    <div id="mobileTestResults">
        <p class="text-muted">Click "Run Tests" to see automated mobile test results.</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    updateMobileDeviceInfo();
    initMobileTestChart();
    
    // Update device info on resize and orientation change
    window.addEventListener('resize', updateMobileDeviceInfo);
    window.addEventListener('orientationchange', function() {
        setTimeout(updateMobileDeviceInfo, 500);
    });
});

function updateMobileDeviceInfo() {
    const width = window.innerWidth;
    const height = window.innerHeight;
    const deviceType = width <= 768 ? 'Mobile' : width <= 1024 ? 'Tablet' : 'Desktop';
    const orientation = width > height ? 'Landscape' : 'Portrait';
    
    document.getElementById('mobileScreenWidth').textContent = width;
    document.getElementById('mobileDeviceType').textContent = deviceType;
    document.getElementById('mobileOrientation').textContent = orientation;
    document.getElementById('mobileViewport').textContent = `${width} × ${height}`;
    document.getElementById('mobileUserAgent').textContent = navigator.userAgent.substring(0, 50) + '...';
}

function initMobileTestChart() {
    const ctx = document.getElementById('mobileTestChart');
    if (ctx) {
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['Mobile', 'Tablet', 'Desktop', 'Large'],
                datasets: [{
                    label: 'Responsiveness Score',
                    data: [100, 98, 95, 92],
                    borderColor: '#009639',
                    backgroundColor: 'rgba(0, 150, 57, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: window.innerWidth > 768
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100
                    }
                }
            }
        });
    }
}

function runMobileTests() {
    const results = [];
    
    // Test for horizontal overflow
    const hasOverflow = document.body.scrollWidth > window.innerWidth;
    results.push({
        test: 'Horizontal Overflow',
        passed: !hasOverflow,
        message: hasOverflow ? 'Page has horizontal scroll' : 'No horizontal overflow detected'
    });
    
    // Test touch targets
    const buttons = document.querySelectorAll('button, .btn, .mobile-nav-link, .mobile-bottom-nav-item');
    let smallTargets = 0;
    buttons.forEach(btn => {
        const rect = btn.getBoundingClientRect();
        if (rect.width < 44 || rect.height < 44) {
            smallTargets++;
        }
    });
    
    results.push({
        test: 'Touch Targets (44px minimum)',
        passed: smallTargets === 0,
        message: smallTargets === 0 ? 'All touch targets meet 44px minimum' : `${smallTargets} targets below 44px`
    });
    
    // Test mobile sidebar
    const sidebar = document.getElementById('mobileSidebar');
    const isMobile = window.innerWidth <= 768;
    if (sidebar) {
        const isHidden = !sidebar.classList.contains('active');
        results.push({
            test: 'Mobile Sidebar',
            passed: isMobile ? isHidden : true,
            message: isMobile ? (isHidden ? 'Properly hidden on mobile' : 'Visible on mobile') : 'Desktop mode'
        });
    }
    
    // Test mobile navigation
    const mobileNav = document.querySelector('.mobile-navbar');
    results.push({
        test: 'Mobile Navigation',
        passed: mobileNav !== null,
        message: mobileNav ? 'Mobile navigation present' : 'Mobile navigation missing'
    });
    
    // Test PWA features
    const manifest = document.querySelector('link[rel="manifest"]');
    results.push({
        test: 'PWA Manifest',
        passed: manifest !== null,
        message: manifest ? 'PWA manifest linked' : 'PWA manifest missing'
    });

    // Test mobile navigation links
    const mobileNavLinks = document.querySelectorAll('a[href*="mobile=1"]');
    results.push({
        test: 'Mobile Navigation Links',
        passed: mobileNavLinks.length > 0,
        message: mobileNavLinks.length > 0 ? `Found ${mobileNavLinks.length} mobile navigation links` : 'No mobile navigation links found'
    });

    // Test if current page has mobile parameter
    const urlParams = new URLSearchParams(window.location.search);
    const hasMobileParam = urlParams.get('mobile') === '1' || window.location.pathname.includes('/mobile/');
    results.push({
        test: 'Mobile Context',
        passed: hasMobileParam,
        message: hasMobileParam ? 'Currently in mobile context' : 'Not in mobile context'
    });

    displayMobileTestResults(results);
}

function displayMobileTestResults(results) {
    const container = document.getElementById('mobileTestResults');
    const passed = results.filter(r => r.passed).length;
    const total = results.length;
    
    let html = `<div class="alert alert-${passed === total ? 'success' : 'warning'} mb-3">
        <strong>Mobile Test Results: ${passed}/${total} passed</strong>
    </div>`;
    
    results.forEach(result => {
        const icon = result.passed ? '✅' : '❌';
        const color = result.passed ? 'success' : 'danger';
        html += `<div class="d-flex align-items-center mb-2">
            <span class="me-2">${icon}</span>
            <div>
                <strong class="text-${color}">${result.test}:</strong>
                <small class="text-muted d-block">${result.message}</small>
            </div>
        </div>`;
    });
    
    container.innerHTML = html;
}

function testMobileSearch() {
    if (window.mobileDashboard) {
        mobileDashboard.toggleMobileSearch();
        setTimeout(() => {
            mobileDashboard.showMobileNotification('Mobile search test completed!', 'success');
        }, 1000);
    }
}

function testMobileNotifications() {
    if (window.mobileDashboard) {
        mobileDashboard.toggleMobileNotifications();
        setTimeout(() => {
            mobileDashboard.showMobileNotification('Mobile notifications test completed!', 'info');
        }, 1000);
    }
}

function testMobileProfile() {
    if (window.mobileDashboard) {
        mobileDashboard.toggleMobileProfile();
        setTimeout(() => {
            mobileDashboard.showMobileNotification('Mobile profile test completed!', 'warning');
        }, 1000);
    }
}

function testMobileGestures() {
    if (window.mobileDashboard) {
        mobileDashboard.showMobileNotification('Try swiping from the left edge to open sidebar!', 'info');
    }
}

function toggleMobileSidebar() {
    if (window.mobileDashboard) {
        mobileDashboard.toggleMobileSidebar();
    }
}
</script>
{% endblock %}
