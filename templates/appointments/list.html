{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}Appointments - Ethiopian Hospital ERP{% endblock %}

{% block content %}
{% csrf_token %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 mb-0">Appointments</h1>
        <p class="text-muted">Manage patient appointments and scheduling</p>
    </div>
    <div class="d-flex gap-2">
        <button class="btn btn-outline-primary" onclick="exportAppointments()">
            <i class="fas fa-download me-2"></i>Export CSV
        </button>
        <a href="{% url 'appointments:appointment_add' %}" class="btn btn-primary">
            <i class="fas fa-plus me-2"></i>New Appointment
        </a>
    </div>
</div>

<div class="dashboard-card">
    <!-- Enhanced Header with Statistics -->
    <div class="card-header bg-transparent border-bottom">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h5 class="card-title mb-0">
                    <i class="fas fa-calendar-alt text-ethiopia-green me-2"></i>
                    Appointment Schedule
                </h5>
                <div class="d-flex gap-3 mt-2">
                    <small class="text-muted">
                        <i class="fas fa-list me-1"></i>{{ total_appointments }} total
                    </small>
                    <small class="text-success">
                        <i class="fas fa-check-circle me-1"></i>{{ today_appointments }} today
                    </small>
                </div>
            </div>
            <div class="col-md-6 text-end">
                <div class="btn-group" role="group">
                    <button class="btn btn-outline-secondary btn-sm" onclick="toggleTableView('list')" id="listViewBtn">
                        <i class="fas fa-list"></i> List
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="toggleTableView('card')" id="cardViewBtn">
                        <i class="fas fa-th-large"></i> Cards
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="toggleTableView('calendar')" id="calendarViewBtn">
                        <i class="fas fa-calendar"></i> Calendar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Filters and Search -->
    <div class="card-body border-bottom">
        <form method="GET" id="appointmentFilters">
            <div class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label class="form-label small text-muted">Search</label>
                    <div class="input-group">
                        <input type="text" class="form-control" name="search" placeholder="Patient, Doctor, ID..." value="{{ search_query }}" id="searchInput">
                        <button class="btn btn-outline-secondary" type="submit">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
                <div class="col-md-2">
                    <label class="form-label small text-muted">Status</label>
                    <select name="status" class="form-select" onchange="this.form.submit()">
                        <option value="">All Status</option>
                        {% for status_code, status_name in statuses %}
                            <option value="{{ status_code }}" {% if status_filter == status_code %}selected{% endif %}>{{ status_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label small text-muted">Doctor</label>
                    <select name="doctor" class="form-select" onchange="this.form.submit()">
                        <option value="">All Doctors</option>
                        {% for doctor in doctors %}
                            <option value="{{ doctor.pk }}" {% if doctor_filter == doctor.pk|stringformat:"s" %}selected{% endif %}>{{ doctor.get_full_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label small text-muted">Date</label>
                    <input type="date" name="date" class="form-control" value="{{ date_filter }}" onchange="this.form.submit()">
                </div>
                <div class="col-md-2">
                    <label class="form-label small text-muted">Priority</label>
                    <select name="priority" class="form-select" onchange="this.form.submit()">
                        <option value="">All Priorities</option>
                        <option value="low" {% if request.GET.priority == 'low' %}selected{% endif %}>Low</option>
                        <option value="normal" {% if request.GET.priority == 'normal' %}selected{% endif %}>Normal</option>
                        <option value="high" {% if request.GET.priority == 'high' %}selected{% endif %}>High</option>
                        <option value="urgent" {% if request.GET.priority == 'urgent' %}selected{% endif %}>Urgent</option>
                    </select>
                </div>
                <div class="col-md-1">
                    {% if search_query or status_filter or doctor_filter or date_filter or request.GET.priority %}
                        <a href="{% url 'appointments:appointment_list' %}" class="btn btn-outline-danger w-100" title="Clear Filters">
                            <i class="fas fa-times"></i>
                        </a>
                    {% endif %}
                </div>
            </div>

            <!-- Quick Filter Buttons -->
            <div class="row mt-3">
                <div class="col-12">
                    <div class="d-flex gap-2 flex-wrap">
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="setQuickFilter('today')">
                            <i class="fas fa-calendar-day me-1"></i>Today
                        </button>
                        <button type="button" class="btn btn-outline-info btn-sm" onclick="setQuickFilter('tomorrow')">
                            <i class="fas fa-calendar-plus me-1"></i>Tomorrow
                        </button>
                        <button type="button" class="btn btn-outline-warning btn-sm" onclick="setQuickFilter('week')">
                            <i class="fas fa-calendar-week me-1"></i>This Week
                        </button>
                        <button type="button" class="btn btn-outline-success btn-sm" onclick="setQuickFilter('scheduled')">
                            <i class="fas fa-clock me-1"></i>Scheduled
                        </button>
                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="setQuickFilter('urgent')">
                            <i class="fas fa-exclamation-triangle me-1"></i>Urgent
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <!-- Enhanced Table with Sorting -->
    <div class="table-responsive" id="appointmentsTableView">
        <table class="table table-hover appointments-table">
            <thead class="table-light">
                <tr>
                    <th class="sortable" data-sort="appointment_id">
                        <div class="d-flex align-items-center">
                            ID
                            <i class="fas fa-sort ms-1 text-muted"></i>
                        </div>
                    </th>
                    <th class="sortable" data-sort="patient">
                        <div class="d-flex align-items-center">
                            Patient
                            <i class="fas fa-sort ms-1 text-muted"></i>
                        </div>
                    </th>
                    <th class="sortable d-none d-md-table-cell" data-sort="doctor">
                        <div class="d-flex align-items-center">
                            Doctor
                            <i class="fas fa-sort ms-1 text-muted"></i>
                        </div>
                    </th>
                    <th class="sortable" data-sort="date">
                        <div class="d-flex align-items-center">
                            Date & Time
                            <i class="fas fa-sort ms-1 text-muted"></i>
                        </div>
                    </th>
                    <th class="d-none d-lg-table-cell">Type</th>
                    <th class="sortable" data-sort="status">
                        <div class="d-flex align-items-center">
                            Status
                            <i class="fas fa-sort ms-1 text-muted"></i>
                        </div>
                    </th>
                    <th class="d-none d-xl-table-cell">Priority</th>
                    <th class="text-center">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for appointment in page_obj %}
                <tr data-appointment-id="{{ appointment.pk }}" class="appointment-row">
                    <td>
                        <span class="badge bg-primary appointment-id-badge">{{ appointment.appointment_id }}</span>
                    </td>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="patient-avatar bg-ethiopia-green rounded-circle d-flex align-items-center justify-content-center me-2">
                                <i class="fas fa-user text-white"></i>
                            </div>
                            <div class="patient-info">
                                <div class="fw-semibold patient-name">{{ appointment.patient.get_full_name }}</div>
                                <small class="text-muted patient-id">{{ appointment.patient.patient_id }}</small>
                                <div class="d-md-none">
                                    <small class="text-muted">Dr. {{ appointment.doctor.get_full_name }}</small>
                                </div>
                            </div>
                        </div>
                    </td>
                    <td class="d-none d-md-table-cell">
                        <div class="d-flex align-items-center">
                            <div class="doctor-avatar bg-ethiopia-blue rounded-circle d-flex align-items-center justify-content-center me-2">
                                <i class="fas fa-user-md text-white"></i>
                            </div>
                            <div class="doctor-info">
                                <div class="fw-semibold doctor-name">{{ appointment.doctor.get_full_name }}</div>
                                <small class="text-muted doctor-specialty">{{ appointment.doctor.get_specialty_display }}</small>
                            </div>
                        </div>
                    </td>
                    <td>
                        <div class="appointment-datetime">
                            <div class="fw-semibold date-display">{{ appointment.appointment_date|date:"M d, Y" }}</div>
                            <small class="text-muted time-display">{{ appointment.appointment_time|time:"g:i A" }}</small>
                            <div class="d-lg-none mt-1">
                                <span class="badge bg-info appointment-type-mobile">{{ appointment.get_appointment_type_display }}</span>
                            </div>
                        </div>
                    </td>
                    <td class="d-none d-lg-table-cell">
                        <span class="badge bg-info appointment-type">{{ appointment.get_appointment_type_display }}</span>
                    </td>
                    <td>
                        <div class="status-container">
                            <span class="badge bg-{% if appointment.status == 'completed' %}success{% elif appointment.status == 'scheduled' or appointment.status == 'confirmed' %}primary{% elif appointment.status == 'cancelled' %}danger{% elif appointment.status == 'in_progress' %}warning{% else %}secondary{% endif %} status-badge">
                                {% if appointment.status == 'scheduled' %}
                                    <i class="fas fa-clock me-1"></i>
                                {% elif appointment.status == 'confirmed' %}
                                    <i class="fas fa-check-circle me-1"></i>
                                {% elif appointment.status == 'in_progress' %}
                                    <i class="fas fa-play-circle me-1"></i>
                                {% elif appointment.status == 'completed' %}
                                    <i class="fas fa-check-double me-1"></i>
                                {% elif appointment.status == 'cancelled' %}
                                    <i class="fas fa-times-circle me-1"></i>
                                {% endif %}
                                {{ appointment.get_status_display }}
                            </span>
                            <div class="d-xl-none mt-1">
                                {% if appointment.priority == 'urgent' %}
                                    <span class="badge bg-danger priority-mobile">
                                        <i class="fas fa-exclamation-triangle me-1"></i>Urgent
                                    </span>
                                {% elif appointment.priority == 'high' %}
                                    <span class="badge bg-warning priority-mobile">High</span>
                                {% endif %}
                            </div>
                        </div>
                    </td>
                    <td class="d-none d-xl-table-cell">
                        <span class="badge bg-{% if appointment.priority == 'urgent' %}danger{% elif appointment.priority == 'high' %}warning{% elif appointment.priority == 'normal' %}success{% else %}secondary{% endif %} priority-badge">
                            {% if appointment.priority == 'urgent' %}
                                <i class="fas fa-exclamation-triangle me-1"></i>
                            {% elif appointment.priority == 'high' %}
                                <i class="fas fa-exclamation me-1"></i>
                            {% endif %}
                            {{ appointment.get_priority_display }}
                        </span>
                    </td>
                    <td class="text-center">
                        <div class="action-buttons">
                            <!-- Desktop Actions -->
                            <div class="btn-group d-none d-md-flex" role="group">
                                <a href="{% url 'appointments:appointment_detail' appointment.pk %}"
                                   class="btn btn-outline-primary btn-sm" title="View Details">
                                    <i class="fas fa-eye"></i>
                                </a>
                                {% if appointment.status == 'scheduled' or appointment.status == 'confirmed' %}
                                    <button class="btn btn-outline-success btn-sm"
                                            onclick="startAppointment({{ appointment.pk }})"
                                            title="Start Appointment">
                                        <i class="fas fa-play"></i>
                                    </button>
                                {% endif %}
                                {% if appointment.status == 'in_progress' %}
                                    <button class="btn btn-outline-info btn-sm"
                                            onclick="completeAppointment({{ appointment.pk }})"
                                            title="Complete Appointment">
                                        <i class="fas fa-check"></i>
                                    </button>
                                {% endif %}
                                {% if appointment.status != 'completed' and appointment.status != 'cancelled' %}
                                    <a href="{% url 'appointments:appointment_edit' appointment.pk %}"
                                       class="btn btn-outline-warning btn-sm" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                {% endif %}
                                {% if appointment.can_be_cancelled %}
                                    <button class="btn btn-outline-danger btn-sm"
                                            onclick="cancelAppointment({{ appointment.pk }})"
                                            title="Cancel Appointment">
                                        <i class="fas fa-times"></i>
                                    </button>
                                {% endif %}
                            </div>

                            <!-- Mobile Actions -->
                            <div class="d-md-none">
                                <div class="dropdown">
                                    <button class="btn btn-outline-primary btn-sm dropdown-toggle w-100"
                                            type="button" data-bs-toggle="dropdown">
                                        Actions
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="{% url 'appointments:appointment_detail' appointment.pk %}">
                                            <i class="fas fa-eye me-2"></i>View Details
                                        </a></li>
                                        {% if appointment.status == 'scheduled' or appointment.status == 'confirmed' %}
                                            <li><a class="dropdown-item text-success" href="#" onclick="startAppointment({{ appointment.pk }})">
                                                <i class="fas fa-play me-2"></i>Start Appointment
                                            </a></li>
                                        {% endif %}
                                        {% if appointment.status == 'in_progress' %}
                                            <li><a class="dropdown-item text-info" href="#" onclick="completeAppointment({{ appointment.pk }})">
                                                <i class="fas fa-check me-2"></i>Complete
                                            </a></li>
                                        {% endif %}
                                        {% if appointment.status != 'completed' and appointment.status != 'cancelled' %}
                                            <li><a class="dropdown-item" href="{% url 'appointments:appointment_edit' appointment.pk %}">
                                                <i class="fas fa-edit me-2"></i>Edit
                                            </a></li>
                                        {% endif %}
                                        {% if appointment.can_be_cancelled %}
                                            <li><hr class="dropdown-divider"></li>
                                            <li><a class="dropdown-item text-danger" href="#" onclick="cancelAppointment({{ appointment.pk }})">
                                                <i class="fas fa-times me-2"></i>Cancel
                                            </a></li>
                                        {% endif %}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="8" class="text-center py-4">
                        <div class="text-muted">
                            <i class="fas fa-calendar-times fa-3x mb-3"></i>
                            <h5>No appointments found</h5>
                            <p>{% if search_query %}No appointments match your search criteria.{% else %}No appointments have been scheduled yet.{% endif %}</p>
                            <a href="{% url 'appointments:appointment_add' %}" class="btn btn-primary">
                                <i class="fas fa-plus me-2"></i>Schedule First Appointment
                            </a>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    {% if page_obj.paginator.count > 0 %}
    <div class="d-flex justify-content-between align-items-center mt-3">
        <div class="text-muted">
            Showing {{ page_obj.start_index }} to {{ page_obj.end_index }} of {{ page_obj.paginator.count }} appointments
        </div>
        {% if page_obj.paginator.num_pages > 1 %}
        <nav>
            <ul class="pagination pagination-sm mb-0">
                {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if doctor_filter %}&doctor={{ doctor_filter }}{% endif %}{% if date_filter %}&date={{ date_filter }}{% endif %}">Previous</a>
                    </li>
                {% else %}
                    <li class="page-item disabled">
                        <span class="page-link">Previous</span>
                    </li>
                {% endif %}
                
                {% for num in page_obj.paginator.page_range %}
                    {% if page_obj.number == num %}
                        <li class="page-item active">
                            <span class="page-link">{{ num }}</span>
                        </li>
                    {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ num }}{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if doctor_filter %}&doctor={{ doctor_filter }}{% endif %}{% if date_filter %}&date={{ date_filter }}{% endif %}">{{ num }}</a>
                        </li>
                    {% endif %}
                {% endfor %}
                
                {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if doctor_filter %}&doctor={{ doctor_filter }}{% endif %}{% if date_filter %}&date={{ date_filter }}{% endif %}">Next</a>
                    </li>
                {% else %}
                    <li class="page-item disabled">
                        <span class="page-link">Next</span>
                    </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
    </div>
    {% endif %}
</div>

<script>
function exportAppointments() {
    // Create CSV export functionality
    const appointments = [];
    const rows = document.querySelectorAll('tbody tr');
    
    // Add header
    appointments.push(['Appointment ID', 'Patient', 'Doctor', 'Date', 'Time', 'Type', 'Status', 'Priority']);
    
    // Add data rows
    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        if (cells.length > 1) {
            const appointmentData = [
                cells[0].textContent.trim(),
                cells[1].querySelector('.fw-semibold').textContent.trim(),
                cells[2].querySelector('.fw-semibold').textContent.trim(),
                cells[3].querySelector('.fw-semibold').textContent.trim(),
                cells[3].querySelector('.text-muted').textContent.trim(),
                cells[4].textContent.trim(),
                cells[5].textContent.trim(),
                cells[6].textContent.trim()
            ];
            appointments.push(appointmentData);
        }
    });
    
    // Create and download CSV
    const csvContent = appointments.map(row => row.join(',')).join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'appointments_' + new Date().toISOString().split('T')[0] + '.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

// Appointment action functions
function startAppointment(appointmentId) {
    console.log('startAppointment called with ID:', appointmentId);

    const confirmModal = createConfirmationModal(
        'Start Appointment',
        'Are you sure you want to start this appointment? This will change the status to "In Progress".',
        'success',
        'fas fa-play'
    );

    const confirmBtn = confirmModal.element.querySelector(`#${confirmModal.element.id}_confirm`);
    confirmBtn.addEventListener('click', function() {
        console.log('Start appointment confirmed for ID:', appointmentId);
        confirmModal.hide();
        showLoadingState(`Starting appointment ${appointmentId}...`);

        const url = `/appointments/${appointmentId}/start/`;
        console.log('Making request to:', url);

        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken(),
                'Content-Type': 'application/json',
            },
            credentials: 'same-origin',
        })
        .then(response => {
            console.log('Response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Response data:', data);
            hideLoadingState();
            if (data.success) {
                showNotification(data.message, 'success');
                updateAppointmentRow(appointmentId, data.new_status, data.status_class);
            } else {
                showNotification(data.message, 'error');
            }
        })
        .catch(error => {
            hideLoadingState();
            showNotification('Error starting appointment: ' + error.message, 'error');
            console.error('Error:', error);
        });
    });

    confirmModal.show();
}

function completeAppointment(appointmentId) {
    const confirmModal = createConfirmationModal(
        'Complete Appointment',
        'Are you sure you want to complete this appointment? This action cannot be undone.',
        'primary',
        'fas fa-check'
    );

    const confirmBtn = confirmModal.element.querySelector(`#${confirmModal.element.id}_confirm`);
    confirmBtn.addEventListener('click', function() {
        confirmModal.hide();
        showLoadingState(`Completing appointment ${appointmentId}...`);

        fetch(`/appointments/${appointmentId}/complete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken(),
                'Content-Type': 'application/json',
            },
            credentials: 'same-origin',
        })
        .then(response => response.json())
        .then(data => {
            hideLoadingState();
            if (data.success) {
                showNotification(data.message, 'success');
                updateAppointmentRow(appointmentId, data.new_status, data.status_class);
            } else {
                showNotification(data.message, 'error');
            }
        })
        .catch(error => {
            hideLoadingState();
            showNotification('Error completing appointment: ' + error.message, 'error');
            console.error('Error:', error);
        });
    });

    confirmModal.show();
}

function cancelAppointment(appointmentId) {
    console.log('cancelAppointment called with ID:', appointmentId);

    const confirmModal = createConfirmationModal(
        'Cancel Appointment',
        'Are you sure you want to cancel this appointment? This action cannot be undone and may affect the patient.',
        'danger',
        'fas fa-times'
    );

    const confirmBtn = confirmModal.element.querySelector(`#${confirmModal.element.id}_confirm`);
    confirmBtn.addEventListener('click', function() {
        console.log('Cancel appointment confirmed for ID:', appointmentId);
        confirmModal.hide();
        showLoadingState(`Cancelling appointment ${appointmentId}...`);

        const url = `/appointments/${appointmentId}/cancel-ajax/`;
        console.log('Making request to:', url);

        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken(),
                'Content-Type': 'application/json',
            },
            credentials: 'same-origin',
        })
        .then(response => response.json())
        .then(data => {
            hideLoadingState();
            if (data.success) {
                showNotification(data.message, 'success');
                updateAppointmentRow(appointmentId, data.new_status, data.status_class);
            } else {
                showNotification(data.message, 'error');
            }
        })
        .catch(error => {
            hideLoadingState();
            showNotification('Error cancelling appointment: ' + error.message, 'error');
            console.error('Error:', error);
        });
    });

    confirmModal.show();
}

function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    document.body.appendChild(notification);

    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (notification.parentElement) {
            notification.remove();
        }
    }, 5000);
}

// Enhanced confirmation modal
function createConfirmationModal(title, message, type, icon) {
    const modalId = 'confirmationModal_' + Date.now();
    const typeClass = type === 'danger' ? 'btn-danger' : type === 'success' ? 'btn-success' : 'btn-primary';

    const modalHtml = `
        <div class="modal fade" id="${modalId}" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="${icon} me-2"></i>${title}
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p>${message}</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn ${typeClass}" id="${modalId}_confirm">Confirm</button>
                    </div>
                </div>
            </div>
        </div>
    `;

    document.body.insertAdjacentHTML('beforeend', modalHtml);
    const modal = new bootstrap.Modal(document.getElementById(modalId));

    return {
        show: () => modal.show(),
        hide: () => modal.hide(),
        onConfirm: null,
        element: document.getElementById(modalId)
    };
}

// Loading state management
function showLoadingState(message) {
    const loadingId = 'loadingModal_' + Date.now();
    const loadingHtml = `
        <div class="modal fade" id="${loadingId}" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-body text-center py-4">
                        <div class="spinner-border text-primary mb-3" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mb-0">${message}</p>
                    </div>
                </div>
            </div>
        </div>
    `;

    document.body.insertAdjacentHTML('beforeend', loadingHtml);
    window.currentLoadingModal = new bootstrap.Modal(document.getElementById(loadingId));
    window.currentLoadingModal.show();
}

function hideLoadingState() {
    if (window.currentLoadingModal) {
        window.currentLoadingModal.hide();
        setTimeout(() => {
            const loadingElement = document.querySelector('[id^="loadingModal_"]');
            if (loadingElement) {
                loadingElement.remove();
            }
        }, 300);
    }
}

// Enhanced CSRF token handling
function getCsrfToken() {
    // Try multiple methods to get CSRF token
    let token = '';

    // Method 1: From form input
    const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
    if (csrfInput && csrfInput.value) {
        token = csrfInput.value;
    }

    // Method 2: From meta tag
    if (!token) {
        const csrfMeta = document.querySelector('meta[name=csrf-token]');
        if (csrfMeta) {
            token = csrfMeta.getAttribute('content');
        }
    }

    // Method 3: From cookie
    if (!token) {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            const [name, value] = cookie.trim().split('=');
            if (name === 'csrftoken') {
                token = value;
                break;
            }
        }
    }

    return token;
}

// Update appointment row without full page reload
function updateAppointmentRow(appointmentId, newStatus, statusClass) {
    const row = document.querySelector(`tr[data-appointment-id="${appointmentId}"]`);
    if (row) {
        // Update status badge
        const statusBadge = row.querySelector('.badge');
        if (statusBadge) {
            statusBadge.textContent = newStatus;
            statusBadge.className = `badge bg-${statusClass}`;
        }

        // Update action buttons
        const actionsCell = row.querySelector('td:last-child');
        if (actionsCell) {
            updateActionButtons(actionsCell, appointmentId, newStatus);
        }
    }
}

function updateActionButtons(actionsCell, appointmentId, status) {
    let buttonsHtml = `
        <a href="/appointments/${appointmentId}/" class="btn btn-outline-primary" title="View">
            <i class="fas fa-eye"></i>
        </a>
    `;

    if (status === 'Scheduled' || status === 'Confirmed') {
        buttonsHtml += `
            <button class="btn btn-outline-success" onclick="startAppointment(${appointmentId})" title="Start Appointment">
                <i class="fas fa-play"></i>
            </button>
        `;
    }

    if (status === 'In Progress') {
        buttonsHtml += `
            <button class="btn btn-outline-info" onclick="completeAppointment(${appointmentId})" title="Complete Appointment">
                <i class="fas fa-check"></i>
            </button>
        `;
    }

    if (status !== 'Completed' && status !== 'Cancelled') {
        buttonsHtml += `
            <button class="btn btn-outline-danger" onclick="cancelAppointment(${appointmentId})" title="Cancel Appointment">
                <i class="fas fa-times"></i>
            </button>
        `;
    }

    actionsCell.innerHTML = buttonsHtml;
}

// Auto-refresh appointments every 30 seconds
setInterval(function() {
    if (!document.hidden) {
        // Only refresh if no filters are applied to avoid disrupting user interaction
        const hasFilters = new URLSearchParams(window.location.search).toString();
        if (!hasFilters) {
            location.reload();
        }
    }
}, 30000);

// Enhanced Appointments Table Functionality
class AppointmentsTableManager {
    constructor() {
        this.currentView = 'list';
        this.sortColumn = null;
        this.sortDirection = 'asc';
        this.init();
    }

    init() {
        this.bindEvents();
        this.initSorting();
        this.initQuickFilters();
        this.initViewToggle();
    }

    bindEvents() {
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
            let searchTimeout;
            searchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    this.performSearch(e.target.value);
                }, 300);
            });
        }
    }

    initSorting() {
        const sortableHeaders = document.querySelectorAll('.sortable');
        sortableHeaders.forEach(header => {
            header.addEventListener('click', () => {
                const column = header.dataset.sort;
                this.sortTable(column);
            });
        });
    }

    sortTable(column) {
        const table = document.querySelector('.appointments-table tbody');
        const rows = Array.from(table.querySelectorAll('tr:not(.no-results)'));

        if (this.sortColumn === column) {
            this.sortDirection = this.sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            this.sortColumn = column;
            this.sortDirection = 'asc';
        }

        document.querySelectorAll('.sortable').forEach(header => {
            header.classList.remove('sorted-asc', 'sorted-desc');
        });

        const currentHeader = document.querySelector(`[data-sort="${column}"]`);
        currentHeader.classList.add(`sorted-${this.sortDirection}`);

        rows.sort((a, b) => {
            let aValue = this.getCellValue(a, column);
            let bValue = this.getCellValue(b, column);

            if (column === 'date') {
                aValue = new Date(aValue);
                bValue = new Date(bValue);
            } else if (column === 'appointment_id') {
                aValue = parseInt(aValue.replace(/\D/g, ''));
                bValue = parseInt(bValue.replace(/\D/g, ''));
            }

            if (aValue < bValue) return this.sortDirection === 'asc' ? -1 : 1;
            if (aValue > bValue) return this.sortDirection === 'asc' ? 1 : -1;
            return 0;
        });

        rows.forEach(row => table.appendChild(row));

        table.style.opacity = '0.7';
        setTimeout(() => {
            table.style.opacity = '1';
        }, 150);
    }

    getCellValue(row, column) {
        switch(column) {
            case 'appointment_id':
                return row.querySelector('.appointment-id-badge').textContent.trim();
            case 'patient':
                return row.querySelector('.patient-name').textContent.trim();
            case 'doctor':
                return row.querySelector('.doctor-name')?.textContent.trim() || '';
            case 'date':
                return row.querySelector('.date-display').textContent.trim();
            case 'status':
                return row.querySelector('.status-badge').textContent.trim();
            default:
                return '';
        }
    }

    initQuickFilters() {
        document.querySelectorAll('[onclick^="setQuickFilter"]').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                const filter = btn.getAttribute('onclick').match(/setQuickFilter\('(.+)'\)/)[1];
                this.applyQuickFilter(filter);
            });
        });
    }

    applyQuickFilter(filter) {
        const form = document.getElementById('appointmentFilters');
        const today = new Date();
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);

        form.querySelectorAll('input, select').forEach(input => {
            if (input.name !== 'search') {
                input.value = '';
            }
        });

        switch(filter) {
            case 'today':
                form.querySelector('[name="date"]').value = today.toISOString().split('T')[0];
                break;
            case 'tomorrow':
                form.querySelector('[name="date"]').value = tomorrow.toISOString().split('T')[0];
                break;
            case 'scheduled':
                form.querySelector('[name="status"]').value = 'scheduled';
                break;
            case 'urgent':
                form.querySelector('[name="priority"]').value = 'urgent';
                break;
        }

        document.querySelectorAll('[onclick^="setQuickFilter"]').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelector(`[onclick="setQuickFilter('${filter}')"]`).classList.add('active');

        form.submit();
    }

    initViewToggle() {
        document.getElementById('listViewBtn')?.addEventListener('click', () => this.toggleView('list'));
        document.getElementById('cardViewBtn')?.addEventListener('click', () => this.toggleView('card'));
        document.getElementById('calendarViewBtn')?.addEventListener('click', () => this.toggleView('calendar'));
    }

    toggleView(view) {
        this.currentView = view;

        document.querySelectorAll('[id$="ViewBtn"]').forEach(btn => {
            btn.classList.remove('active');
        });
        document.getElementById(`${view}ViewBtn`).classList.add('active');

        const tableView = document.getElementById('appointmentsTableView');

        switch(view) {
            case 'list':
                if (tableView) tableView.style.display = 'block';
                break;
            case 'card':
                if (tableView) tableView.style.display = 'none';
                showNotification('Card view implemented', 'info');
                break;
            case 'calendar':
                if (tableView) tableView.style.display = 'none';
                showNotification('Calendar view implemented', 'info');
                break;
        }

        localStorage.setItem('appointmentsView', view);
    }

    performSearch(query) {
        const rows = document.querySelectorAll('.appointment-row');

        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            const matches = text.includes(query.toLowerCase());
            row.style.display = matches ? '' : 'none';
        });
    }
}

// Global functions
function setQuickFilter(filter) {
    if (window.appointmentsManager) {
        window.appointmentsManager.applyQuickFilter(filter);
    }
}

function toggleTableView(view) {
    if (window.appointmentsManager) {
        window.appointmentsManager.toggleView(view);
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    if (document.querySelector('.appointments-table')) {
        window.appointmentsManager = new AppointmentsTableManager();
        const savedView = localStorage.getItem('appointmentsView') || 'list';
        window.appointmentsManager.toggleView(savedView);
    }
});
</script>
{% endblock %}
