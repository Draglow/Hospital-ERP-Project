{% extends 'dashboard/mobile/base.html' %}
{% load static %}

{% block title %}Test Mobile Appointment Actions - Ethiopian Hospital ERP{% endblock %}

{% block content %}
{% csrf_token %}

<!-- Mobile Page Header -->
<div class="mobile-page-header">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h1 class="h4 mb-1">Test Appointment Actions</h1>
            <p class="text-muted mb-0">Test mobile start/cancel functionality</p>
        </div>
        <div>
            <a href="{% url 'appointments:appointment_list' %}?mobile=1" class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-arrow-left"></i>
            </a>
        </div>
    </div>
</div>

<!-- Test Controls -->
<div class="mobile-dashboard-card mb-3">
    <h6 class="text-ethiopia-green mb-3">Test Controls</h6>
    
    <div class="mb-3">
        <label for="appointmentId" class="form-label">Appointment ID to Test</label>
        <input type="number" class="form-control" id="appointmentId" placeholder="Enter appointment ID (e.g., 1, 2, 3...)">
    </div>
    
    <div class="row g-2">
        <div class="col-4">
            <button class="btn btn-success w-100" onclick="testStartAppointment()">
                <i class="fas fa-play me-1"></i>Start
            </button>
        </div>
        <div class="col-4">
            <button class="btn btn-info w-100" onclick="testCompleteAppointment()">
                <i class="fas fa-check me-1"></i>Complete
            </button>
        </div>
        <div class="col-4">
            <button class="btn btn-danger w-100" onclick="testCancelAppointment()">
                <i class="fas fa-times me-1"></i>Cancel
            </button>
        </div>
    </div>
</div>

<!-- Test Results -->
<div class="mobile-dashboard-card">
    <h6 class="text-ethiopia-blue mb-3">Test Results</h6>
    <div id="testResults" class="alert alert-info">
        <i class="fas fa-info-circle me-2"></i>
        Enter an appointment ID above and click a button to test the functionality.
    </div>
</div>

<!-- Instructions -->
<div class="mobile-dashboard-card">
    <h6 class="text-ethiopia-yellow mb-3">Instructions</h6>
    <ol class="small">
        <li>Go to <a href="{% url 'appointments:appointment_list' %}?mobile=1">Appointments List</a> to find an appointment ID</li>
        <li>Enter the appointment ID in the field above</li>
        <li>Click "Start" to test starting an appointment</li>
        <li>Click "Complete" to test completing an appointment</li>
        <li>Click "Cancel" to test cancelling an appointment</li>
        <li>Check the results below</li>
    </ol>
</div>
{% endblock %}

{% block extra_css %}
<style>
.mobile-dashboard-card {
    margin-bottom: 1.5rem;
}

.alert {
    border-radius: 8px;
    border: none;
}

.alert-success {
    background-color: rgba(25, 135, 84, 0.1);
    color: #0f5132;
    border-left: 4px solid #198754;
}

.alert-danger {
    background-color: rgba(220, 53, 69, 0.1);
    color: #721c24;
    border-left: 4px solid #dc3545;
}

.alert-info {
    background-color: rgba(13, 110, 253, 0.1);
    color: #055160;
    border-left: 4px solid #0dcaf0;
}

.btn {
    border-radius: 8px;
    font-weight: 500;
    padding: 8px 12px;
    transition: all 0.2s ease;
}

.btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}
</style>
{% endblock %}

{% block extra_js %}
<script>
function getAppointmentId() {
    const appointmentId = document.getElementById('appointmentId').value;
    if (!appointmentId) {
        showResult('Please enter an appointment ID first.', 'danger');
        return null;
    }
    return appointmentId;
}

function showResult(message, type = 'info') {
    const resultsDiv = document.getElementById('testResults');
    resultsDiv.className = `alert alert-${type}`;
    resultsDiv.innerHTML = `<i class="fas fa-${type === 'success' ? 'check' : type === 'danger' ? 'times' : 'info'}-circle me-2"></i>${message}`;
}

function testStartAppointment() {
    const appointmentId = getAppointmentId();
    if (!appointmentId) return;
    
    showResult('Testing start appointment...', 'info');
    
    fetch(`/appointments/${appointmentId}/start/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showResult(`✅ SUCCESS: ${data.message}`, 'success');
            if (window.mobileDashboard) {
                mobileDashboard.showMobileNotification(data.message, 'success');
            }
        } else {
            showResult(`❌ ERROR: ${data.message}`, 'danger');
            if (window.mobileDashboard) {
                mobileDashboard.showMobileNotification(data.message, 'danger');
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showResult(`❌ NETWORK ERROR: ${error.message}`, 'danger');
        if (window.mobileDashboard) {
            mobileDashboard.showMobileNotification('Network error occurred', 'danger');
        }
    });
}

function testCompleteAppointment() {
    const appointmentId = getAppointmentId();
    if (!appointmentId) return;
    
    showResult('Testing complete appointment...', 'info');
    
    fetch(`/appointments/${appointmentId}/complete/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showResult(`✅ SUCCESS: ${data.message}`, 'success');
            if (window.mobileDashboard) {
                mobileDashboard.showMobileNotification(data.message, 'success');
            }
        } else {
            showResult(`❌ ERROR: ${data.message}`, 'danger');
            if (window.mobileDashboard) {
                mobileDashboard.showMobileNotification(data.message, 'danger');
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showResult(`❌ NETWORK ERROR: ${error.message}`, 'danger');
        if (window.mobileDashboard) {
            mobileDashboard.showMobileNotification('Network error occurred', 'danger');
        }
    });
}

function testCancelAppointment() {
    const appointmentId = getAppointmentId();
    if (!appointmentId) return;
    
    if (!confirm('Are you sure you want to test cancelling this appointment?')) {
        return;
    }
    
    showResult('Testing cancel appointment...', 'info');
    
    fetch(`/appointments/${appointmentId}/cancel-ajax/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showResult(`✅ SUCCESS: ${data.message}`, 'success');
            if (window.mobileDashboard) {
                mobileDashboard.showMobileNotification(data.message, 'success');
            }
        } else {
            showResult(`❌ ERROR: ${data.message}`, 'danger');
            if (window.mobileDashboard) {
                mobileDashboard.showMobileNotification(data.message, 'danger');
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showResult(`❌ NETWORK ERROR: ${error.message}`, 'danger');
        if (window.mobileDashboard) {
            mobileDashboard.showMobileNotification('Network error occurred', 'danger');
        }
    });
}

document.addEventListener('DOMContentLoaded', function() {
    console.log('Mobile appointment test page loaded');
    
    if (window.mobileDashboard) {
        mobileDashboard.showMobileNotification('Test page loaded successfully!', 'info');
    }
});
</script>
{% endblock %}
